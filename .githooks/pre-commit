#!/usr/bin/env bash
# Verify staged .json files are valid UTF-8, valid JSON, and contain no unpaired surrogates
set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Collect staged JSON files (Added, Copied, Modified, Renamed), NUL-delimited and space-safe
JSON_FILES=()
while IFS= read -r -d '' f; do
  JSON_FILES+=("$f")
done < <(git diff --cached --name-only -z --diff-filter=ACMR -- '*.json')

if [[ ${#JSON_FILES[@]} -eq 0 ]]; then
  exit 0
fi

echo "Running JSON Unicode validation on staged files..."
python3 scripts/validate_json_unicode.py "${JSON_FILES[@]}"

# If the validator exits non-zero, this hook will fail due to `set -e`
exit 0
