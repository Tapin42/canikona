{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<h1>{{ page_title }}</h1>

        <div class="controls-container">
            <form id="selection-form">
                <div class="selection-group">
                    <label for="race-select">Race:</label>
                    <select name="race_name" id="race-select">
                        {% for race in races %}
                            <option value="{{ race.name }}"
                                    data-distance="{{ race.distance }}"
                                    data-slots="{{ race.slots if race.distance == '140.6' else '' }}"
                                    data-slots-men="{{ race.slots.men if race.distance == '70.3' else '' }}"
                                    data-slots-women="{{ race.slots.women if race.distance == '70.3' else '' }}"
                                    data-slot-policy="{{ race.slot_policy if race.slot_policy else '' }}"
                                    {% if race.name == selected_race %}selected{% endif %}>
                                {{ race.date }} - {{ race.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <div id="slots-display" class="slots-info"></div>
                </div>

                <div class="selection-group">
                    <p>Data Source:</p>
                    <label><input type="radio" name="data_source" value="live" {% if selected_source == 'live' %}checked{% endif %}> Live</label>
                    <label><input type="radio" name="data_source" value="official_ag" {% if selected_source == 'official_ag' %}checked{% endif %}> Official Rolldown List</label>
                </div>

                <div id="gender-selection" class="selection-group">
                    <p>Gender:</p>
                    <label><input type="radio" name="gender" value="men" {% if selected_gender == 'men' %}checked{% endif %}> Men</label>
                    <label><input type="radio" name="gender" value="women" {% if selected_gender == 'women' %}checked{% endif %}> Women</label>
                </div>
            </form>
        </div>

    <div id="slot-summary-container">
        {% include 'partials/slot_summary.html' %}
    </div>

        <div id="results-display">
            <!-- Loading overlay with spinner -->
            <div id="loading-overlay">
                <div class="spinner"></div>
            </div>

            <!-- Rolldown information for official results -->
            <div id="rolldown-info" class="rolldown-message">
                <div id="rolldown-content"></div>
            </div>

            <!-- Results containers -->
            <div id="message-area"></div>
            <iframe id="results-iframe" frameborder="0"></iframe>
        </div>
    </div>

    <script>
    const racesData = {{ races | tojson }};

        function setupTooltip(tooltipContainer) {
            const icon = tooltipContainer.querySelector('.tooltip-icon');
            icon.addEventListener('click', (e) => {
                e.stopPropagation();  // Prevent document click from immediately closing
                // Close any other open tooltips
                document.querySelectorAll('.tooltip.active').forEach(t => {
                    if (t !== tooltipContainer) t.classList.remove('active');
                });
                tooltipContainer.classList.toggle('active');
            });
        }

        // Close tooltips when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.tooltip')) {
                document.querySelectorAll('.tooltip.active').forEach(tooltip => {
                    tooltip.classList.remove('active');
                });
            }
        });

    function updateRolldownInfo(source, race) {
            const rolldownDiv = document.getElementById('rolldown-info');
            const rolldownContent = document.getElementById('rolldown-content');

            // Hide rolldown info if not official_ag source
            if (source !== 'official_ag') {
                rolldownDiv.style.display = 'none';
                return;
            }

            // Hide if no race found or no known_rolldown available for this race
            if (!race) {
                rolldownDiv.style.display = 'none';
                return;
            }

            // For 70.3 races, check gender-specific rolldown; for 140.6, use the number directly
            let rolldownPosition = null;
            if (race.known_rolldown) {
                if (race.distance === '70.3') {
                    const selectedGender = document.querySelector('input[name="gender"]:checked')?.value;
                    if (selectedGender && race.known_rolldown[selectedGender]) {
                        rolldownPosition = race.known_rolldown[selectedGender];
                    }
                } else if (race.distance === '140.6') {
                    if (typeof race.known_rolldown === 'number') {
                        rolldownPosition = race.known_rolldown;
                    }
                }
            }

            let content = '';
            if (rolldownPosition) {
                // Display message with known rolldown data
                content = `<span class="rolldown-content-text">
                        <strong>Performance Pool Info</strong>:
                        The performance pool rolled down to at least position <strong>${rolldownPosition}</strong> for this race.
                    </span>
                    <span class="tooltip">
                        <span class="tooltip-icon">ⓘ</span>
                        <span class="tooltip-text">Are you aware of a performance pool spot at a later number? <a href="/about">Contact the site admin</a> and we'll update this info.</span>
                    </span>`;
            } else {
                // Display message asking for rolldown data
                content = `<p class="rolldown-content-text">
                    <strong>Performance Pool Info</strong>:
                    Did you get a performance pool slot? Do you know how far the performance pool rolled down for this race? <a href="/about">Contact the site admin</a> and we'll display that info here.
                </p>`;
            }

            rolldownContent.innerHTML = content;
            rolldownDiv.style.display = 'block';

            // Setup tooltip if present
            const tooltip = rolldownContent.querySelector('.tooltip');
            if (tooltip) {
                setupTooltip(tooltip);
            }
        }

    function updateSlotsDisplay() {
            const raceSelect = document.getElementById('race-select');
            const selectedOption = raceSelect.options[raceSelect.selectedIndex];
            const slotsDisplay = document.getElementById('slots-display');
            const distance = selectedOption.getAttribute('data-distance');
            const genderInputs = document.getElementsByName('gender');

            const slotPolicy = selectedOption.getAttribute('data-slot-policy') || '';
            const isSplit = slotPolicy.startsWith('split');

            // Ensure there's always a selected gender for split policies
            if (isSplit && ![...genderInputs].some(input => input.checked)) {
                genderInputs[0].checked = true;
            }

            const selectedGender = [...genderInputs].find(input => input.checked)?.value;

            // Common tooltip markup
            const tooltipHtml = `<span class="tooltip">
                <span class="tooltip-icon">ⓘ</span>
                <span class="tooltip-text">
                    Total number of slots allocated to the race; see the
                    <a href="https://www.ironman.com/about/age-group-qualification" target="_blank">Age
                    Group Qualification System</a> page for details on how slots will be assigned.
                </span>
            </span>`;

            if (distance === '140.6') {
                const totalSlots = selectedOption.getAttribute('data-slots');
                slotsDisplay.innerHTML = `Available Slots: <strong>${totalSlots}</strong>${tooltipHtml}`;
                slotsDisplay.style.display = 'block';
                setupTooltip(slotsDisplay.querySelector('.tooltip'));
            } else if (distance === '70.3' && selectedGender) {
                const slots = selectedGender === 'men'
                    ? selectedOption.getAttribute('data-slots-men')
                    : selectedOption.getAttribute('data-slots-women');
                const genderDisplay = selectedGender === 'men' ? 'Men' : 'Women';
                slotsDisplay.innerHTML = `Available Slots For ${genderDisplay}: <strong>${slots}</strong>${tooltipHtml}`;
                slotsDisplay.style.display = 'block';
                setupTooltip(slotsDisplay.querySelector('.tooltip'));
            } else {
                slotsDisplay.style.display = 'none';
            }
        }

        function findRaceData(raceName) {
            return racesData.find(race => race.name === raceName);
        }

        async function refreshSlotSummary(race, gender) {
            try {
                const name = (race?.name || '').replace(/ /g, '_');
                if (!name) return;
                const params = new URLSearchParams();
                if (gender) params.set('gender', gender);
                const res = await fetch(`/fragment/slot_summary/${name}?${params.toString()}`);
                if (!res.ok) return;
                const html = await res.text();
                const container = document.getElementById('slot-summary-container');
                if (!container) return;
                container.innerHTML = html;

                // Execute any inline scripts inside the injected HTML
                const scripts = Array.from(container.querySelectorAll('script'));
                scripts.forEach((oldScript) => {
                    const s = document.createElement('script');
                    // Copy attributes
                    for (const attr of oldScript.attributes) {
                        s.setAttribute(attr.name, attr.value);
                    }
                    s.text = oldScript.textContent || '';
                    // Use body append to ensure execution context
                    document.body.appendChild(s);
                    // Remove the original to avoid duplicates
                    oldScript.remove();
                });
            } catch (e) {
                // Silent failure; panel just won't update
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const raceSelect = document.getElementById('race-select');
            const sourceRadios = document.querySelectorAll('input[name="data_source"]');
            const genderRadios = document.querySelectorAll('input[name="gender"]');
            const genderDiv = document.getElementById('gender-selection');
            const iframe = document.getElementById('results-iframe');
            const messageArea = document.getElementById('message-area');
            const loadingOverlay = document.getElementById('loading-overlay');

            // Initialize slots display
            updateSlotsDisplay();

            // Handle race selection changes
            raceSelect.addEventListener('change', function() {
                const distance = this.options[this.selectedIndex].getAttribute('data-distance');
                // When switching to 70.3, ensure first gender option is selected
                if (distance === '70.3') {
                    const menRadio = document.querySelector('input[name="gender"][value="men"]');
                    menRadio.checked = true;
                }
                updateSlotsDisplay();
            });

            // Handle gender selection changes
            genderRadios.forEach(radio => {
                radio.addEventListener('change', updateSlotsDisplay);
            });

            function showLoading() {
                loadingOverlay.style.display = 'block';
                iframe.style.display = 'none';
                messageArea.style.display = 'none';
            }

            function hideLoading() {
                loadingOverlay.style.display = 'none';
            }

            async function updateAll() {
                const selectedRaceName = raceSelect.value;
                const race = findRaceData(selectedRaceName);
                const source = document.querySelector('input[name="data_source"]:checked').value;
                const slotPolicy = race.slot_policy || '';
                const isSplit = slotPolicy.startsWith('split');
                const is703 = race.distance === '70.3';

                // Get gender only for split policies
                const gender = isSplit ? document.querySelector('input[name="gender"]:checked').value : null;

                if (isSplit) {
                    genderDiv.classList.remove('disabled-controls');
                    genderRadios.forEach(radio => radio.disabled = false);
                } else {
                    genderDiv.classList.add('disabled-controls');
                    genderRadios.forEach(radio => radio.disabled = true);
                }

                const urlFriendlyName = selectedRaceName.replace(/ /g, '_');
                let urlPath = `/results/${urlFriendlyName}/${source}`;
                if (isSplit) {
                    urlPath += `/${gender}`;
                }
                window.history.pushState({}, '', urlPath);

                // Scroll to top of page smoothly and show loading
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                showLoading();

                // Refresh the slot summary fragment to reflect the newly selected race/gender
                refreshSlotSummary(race, isSplit ? gender : null);

                updateRolldownInfo(source, race);

                if (source === 'official_ag' && race.results_urls && race.results_urls.official_ag) {
                    let url = race.results_urls.official_ag;
                    if (is703) {
                        // Handle 70.3 race with gender-specific URLs
                        if (url[gender] && url[gender] !== "") {
                            iframe.onload = hideLoading;
                            iframe.src = url[gender];
                            iframe.style.display = 'block';
                            messageArea.style.display = 'none';
                        } else {
                            iframe.style.display = 'none';
                            messageArea.style.display = 'block';
                            messageArea.innerText = 'Coming Soon!';
                        }
                    } else if (typeof url === 'string') {
                        // Handle 140.6 race with single URL
                        iframe.onload = hideLoading;
                        iframe.src = url;
                        iframe.style.display = 'block';
                        messageArea.style.display = 'none';
                    } else {
                        iframe.style.display = 'none';
                        messageArea.style.display = 'block';
                        messageArea.innerText = 'Coming Soon!';
                    }
                } else if (source === 'live') {
                    let liveUrl = isSplit
                        ? `/live_results/${urlFriendlyName}/${gender}`
                        : `/live_results/${urlFriendlyName}`;
                    iframe.onload = hideLoading;
                    iframe.src = liveUrl;
                    iframe.style.display = 'block';
                    messageArea.style.display = 'none';

                } else {
                    iframe.style.display = 'none';
                    messageArea.style.display = 'block';
                    messageArea.innerText = 'Coming Soon!';
                    hideLoading();
                }
            }

            let isInitialLoad = true;

            function onRaceChange() {
                // Determine current race
                const selectedRaceName = isInitialLoad ? ('{{ selected_race }}' || raceSelect.value) : raceSelect.value;
                const race = findRaceData(selectedRaceName);

                // Helpers to query radios and availability
                const officialAgRadio = document.querySelector('input[name="data_source"][value="official_ag"]');
                const liveRadio = document.querySelector('input[name="data_source"][value="live"]');

                function officialAvailable(r) {
                    if (!r || !r.results_urls || !('official_ag' in r.results_urls)) return false;
                    if (r.distance === '70.3') {
                        const men = r.results_urls.official_ag?.men ?? '';
                        const women = r.results_urls.official_ag?.women ?? '';
                        return Boolean((men && men.trim()) || (women && women.trim()));
                    }
                    const url = r.results_urls.official_ag;
                    return typeof url === 'string' && Boolean(url.trim());
                }

                const hasOfficialAg = officialAvailable(race);

                // Enable/disable only the Official radio based on availability
                officialAgRadio.disabled = !hasOfficialAg;
                officialAgRadio.parentElement.classList.toggle('disabled-controls', !hasOfficialAg);

                // Live should always be available
                liveRadio.disabled = false;
                liveRadio.parentElement.classList.remove('disabled-controls');

                // Selection policy
                // 1) On initial load: honor server-provided selected_source if available; else fall back smartly
                // 2) On subsequent race changes: preserve user's current selection if it's still valid; otherwise fall back
                const serverSelected = '{{ selected_source }}';
                const currentChecked = document.querySelector('input[name="data_source"]:checked')?.value;

                let nextSource = currentChecked || 'live';
                if (isInitialLoad && serverSelected) {
                    // Use server value only if it's valid for this race
                    if (serverSelected === 'official_ag' && hasOfficialAg) {
                        nextSource = 'official_ag';
                    } else {
                        nextSource = 'live';
                    }
                } else {
                    // If current selection is official but it's not available for this race, fall back to live
                    if (currentChecked === 'official_ag' && !hasOfficialAg) {
                        nextSource = 'live';
                    }
                }

                // Apply selection
                document.querySelector(`input[name="data_source"][value="${nextSource}"]`).checked = true;
                isInitialLoad = false;

                // For 70.3 ensure a gender is picked (default to men)
                if (race.distance === '70.3') {
                    document.querySelector('input[name="gender"][value="men"]').checked = true;
                }

                updateAll();
            }

            raceSelect.addEventListener('change', onRaceChange);
            sourceRadios.forEach(radio => radio.addEventListener('change', updateAll));
            genderRadios.forEach(radio => radio.addEventListener('change', updateAll));

            onRaceChange();
        });
    </script>
{% endblock %}