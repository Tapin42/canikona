<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script>
        const racesData = {{ races | tojson }};
    </script>
</head>
<body>
    <div class="container">
        <h1>{{ page_title }}</h1>

        <p>Select a race and a data source to view age-graded results.</p>

        <div class="controls-container">
            <form id="selection-form">
                <div class="selection-group">
                    <label for="race-select">Race:</label>
                    <select name="race_name" id="race-select">
                        {% for race in races %}
                            <option value="{{ race.name }}" data-distance="{{ race.distance }}" {% if race.name == selected_race %}selected{% endif %}>
                                {{ race.date }} - {{ race.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="selection-group">
                    <p>Data Source:</p>
                    <label><input type="radio" name="data_source" value="live" {% if selected_source == 'live' %}checked{% endif %}> Live</label>
                    <label><input type="radio" name="data_source" value="official_site" {% if selected_source == 'official_site' %}checked{% endif %}> IM Site</label>
                    <label><input type="radio" name="data_source" value="official_ag" {% if selected_source == 'official_ag' %}checked{% endif %}> Official Rolldown List</label>
                </div>

                <div id="gender-selection" class="selection-group">
                    <p>Gender:</p>
                    <label><input type="radio" name="gender" value="men" {% if selected_gender == 'men' %}checked{% endif %}> Men</label>
                    <label><input type="radio" name="gender" value="women" {% if selected_gender == 'women' %}checked{% endif %}> Women</label>
                </div>
                <button type="submit" style="display: none;">View Results</button>
            </form>
        </div>

        <div id="results-display">
            <div id="spinner" class="spinner"></div>
            <p id="message-area" style="display: none;"></p>
            <div id="live-results-container"></div>
            <iframe id="results-iframe" frameborder="0"></iframe>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const raceSelect = document.getElementById('race-select');
            const sourceRadios = document.querySelectorAll('input[name="data_source"]');
            const genderRadios = document.querySelectorAll('input[name="gender"]');
            const genderDiv = document.getElementById('gender-selection');
            const iframe = document.getElementById('results-iframe');
            const spinner = document.getElementById('spinner');
            const messageArea = document.getElementById('message-area');
            const liveResultsContainer = document.getElementById('live-results-container');

            let currentSortColumn = null;
            let currentSortOrder = 'asc';
            let liveResultsData = [];

            function findRaceData(raceName) {
                return racesData.find(race => race.name === raceName);
            }

            function showLoadingState() {
                messageArea.style.display = 'none';
                iframe.style.display = 'none';
                liveResultsContainer.innerHTML = '';
                spinner.style.display = 'block';
            }

            function hideLoadingState() {
                spinner.style.display = 'none';
            }

            // Helper function to round and format time for display
            function formatTimeForDisplay(timeStr) {
                if (!timeStr) return '';
                const parts = timeStr.split(':').map(Number);
                const secondsWithFraction = parts[2] + (parts[3] / 1000 || 0);
                const roundedSeconds = Math.ceil(secondsWithFraction);

                const roundedTime = parts[0] * 3600 + parts[1] * 60 + roundedSeconds;

                const hours = Math.floor(roundedTime / 3600);
                const minutes = Math.floor((roundedTime % 3600) / 60);
                const seconds = roundedTime % 60;

                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            function renderLiveResultsTable(data) {
                if (!data || data.length === 0) {
                    messageArea.innerText = "No live results found.";
                    messageArea.style.display = 'block';
                    return;
                }

                liveResultsData = data;
                const headers = [
                    { key: 'graded_place', label: 'Graded Place' },
                    { key: 'bib', label: 'Bib' },
                    { key: 'name', label: 'Name' },
                    { key: 'age_group', label: 'Age Group' },
                    { key: 'gender_place', label: 'Gender Place' },
                    { key: 'finish_time', label: 'Finish Time' },
                    { key: 'graded_time', label: 'Graded Time' }
                ];

                let tableHTML = '<table class="results-table"><thead><tr>';
                headers.forEach(header => {
                    const sortedClass = header.key === currentSortColumn
                        ? (currentSortOrder === 'asc' ? 'sorted-asc' : 'sorted-desc')
                        : '';
                    tableHTML += `<th data-sort-by="${header.key}" class="${sortedClass}">${header.label}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';

                const sortedData = [...liveResultsData].sort((a, b) => {
                    const key = currentSortColumn;
                    if (!key) return 0;

                    const aVal = a[key];
                    const bVal = b[key];

                    let comparison = 0;
                    if (typeof aVal === 'string' && typeof bVal === 'string') {
                        if (['graded_place', 'gender_place'].includes(key)) {
                            comparison = parseInt(aVal) - parseInt(bVal);
                        } else {
                            comparison = aVal.localeCompare(bVal);
                        }
                    } else if (typeof aVal === 'number' && typeof bVal === 'number') {
                         comparison = aVal - bVal;
                    } else {
                        // Special handling for time strings
                        if (key === 'graded_time') {
                            comparison = a.graded_time_seconds - b.graded_time_seconds;
                        } else if (key === 'finish_time') {
                             comparison = a.finish_time_seconds - b.finish_time_seconds;
                        } else {
                            comparison = String(aVal).localeCompare(String(bVal));
                        }
                    }

                    return currentSortOrder === 'desc' ? -comparison : comparison;
                });

                sortedData.forEach(athlete => {
                    tableHTML += `<tr>
                        <td>${athlete.graded_place}</td>
                        <td>${athlete.bib}</td>
                        <td>${athlete.name}</td>
                        <td>${athlete.age_group}</td>
                        <td>${athlete.gender_place}</td>
                        <td>${formatTimeForDisplay(athlete.finish_time)}</td>
                        <td>${formatTimeForDisplay(athlete.graded_time)}</td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';

                liveResultsContainer.innerHTML = tableHTML;
                liveResultsContainer.style.display = 'block';
                messageArea.style.display = 'none';

                document.querySelectorAll('.results-table th').forEach(header => {
                    header.addEventListener('click', () => {
                        const newSortColumn = header.dataset.sortBy;
                        if (newSortColumn === currentSortColumn) {
                            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSortColumn = newSortColumn;
                            currentSortOrder = 'asc';
                        }
                        renderLiveResultsTable(liveResultsData);
                    });
                });
            }

            async function updateAll() {
                const selectedRaceName = raceSelect.value;
                const race = findRaceData(selectedRaceName);
                const source = document.querySelector('input[name="data_source"]:checked').value;
                const gender = document.querySelector('input[name="gender"]:checked').value;

                const is703 = race.distance === '70.3';
                if (is703) {
                    genderDiv.classList.remove('disabled-controls');
                    genderRadios.forEach(radio => radio.disabled = false);
                } else {
                    genderDiv.classList.add('disabled-controls');
                    genderRadios.forEach(radio => radio.disabled = true);
                }

                let urlPath = `/results/${encodeURIComponent(selectedRaceName)}/${source}`;
                if (is703) {
                    urlPath += `/${gender}`;
                }
                window.history.pushState({}, '', urlPath);

                liveResultsContainer.innerHTML = '';
                liveResultsContainer.style.display = 'none';

                if (source === 'official_ag' && race.results_urls && race.results_urls.official_ag) {
                    let url = race.results_urls.official_ag;
                    if (is703 && url[gender]) {
                        iframe.src = url[gender];
                        iframe.style.display = 'block';
                        messageArea.style.display = 'none';
                    } else if (!is703 && typeof url === 'string') {
                        iframe.src = url;
                        iframe.style.display = 'block';
                        messageArea.style.display = 'none';
                    } else {
                        iframe.style.display = 'none';
                        messageArea.style.display = 'block';
                        messageArea.innerText = 'Coming Soon!';
                    }
                } else if (source === 'live') {
                    showLoadingState();
                    try {
                        const response = await fetch(`/api/live_results/${encodeURIComponent(selectedRaceName)}/${gender}`);
                        const data = await response.json();
                        hideLoadingState();

                        if (response.ok) {
                            if (data.results) {
                                currentSortColumn = 'graded_place';
                                currentSortOrder = 'asc';
                                renderLiveResultsTable(data.results);
                            } else {
                                messageArea.innerText = "Error: Live results data not found.";
                                messageArea.style.display = 'block';
                            }
                        } else {
                            messageArea.innerText = `Error: ${data.error || 'Could not retrieve live data'}`;
                            messageArea.style.display = 'block';
                        }
                    } catch (error) {
                        hideLoadingState();
                        messageArea.innerText = 'Error: Failed to connect to server.';
                        messageArea.style.display = 'block';
                    }
                    return;
                } else {
                    iframe.style.display = 'none';
                    messageArea.style.display = 'block';
                    messageArea.innerText = 'Coming Soon!';
                }
                hideLoadingState();
            }

            function onRaceChange() {
                const selectedRaceName = raceSelect.value;
                const race = findRaceData(selectedRaceName);
                const hasOfficialAg = race.results_urls && 'official_ag' in race.results_urls;

                document.querySelector(`input[name="data_source"][value="${hasOfficialAg ? 'official_ag' : 'live'}"]`).checked = true;

                if (race.distance === '70.3') {
                    document.querySelector('input[name="gender"][value="men"]').checked = true;
                }

                updateAll();
            }

            raceSelect.addEventListener('change', onRaceChange);
            sourceRadios.forEach(radio => radio.addEventListener('change', updateAll));
            genderRadios.forEach(radio => radio.addEventListener('change', updateAll));

            onRaceChange();
        });
    </script>
</body>
</html>