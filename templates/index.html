<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script>
        const racesData = {{ races | tojson }};
    </script>
</head>
<body>
    <div class="container">
        <h1>{{ page_title }}</h1>

        <div class="controls-container">
            <form id="selection-form">
                <div class="selection-group">
                    <label for="race-select">Race:</label>
                    <select name="race_name" id="race-select">
                        {% for race in races %}
                            <option value="{{ race.name }}" data-distance="{{ race.distance }}" {% if race.name == selected_race %}selected{% endif %}>
                                {{ race.date }} - {{ race.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="selection-group">
                    <p>Data Source:</p>
                    <label><input type="radio" name="data_source" value="live" {% if selected_source == 'live' %}checked{% endif %}> Live</label>
                    <label><input type="radio" name="data_source" value="official_ag" {% if selected_source == 'official_ag' %}checked{% endif %}> Official Rolldown List</label>
                </div>

                <div id="gender-selection" class="selection-group">
                    <p>Gender:</p>
                    <label><input type="radio" name="gender" value="men" {% if selected_gender == 'men' %}checked{% endif %}> Men</label>
                    <label><input type="radio" name="gender" value="women" {% if selected_gender == 'women' %}checked{% endif %}> Women</label>
                </div>
                <button type="submit" style="display: none;">View Results</button>
            </form>
        </div>

        <div id="results-display">
            <!-- Loading overlay with spinner -->
            <div id="loading-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 1000;">
                <div class="spinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
            </div>

            <!-- Results containers -->
            <div id="message-area" style="display: none;"></div>
            <iframe id="results-iframe" frameborder="0" style="width: 100%; min-height: 500px;"></iframe>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const raceSelect = document.getElementById('race-select');
            const sourceRadios = document.querySelectorAll('input[name="data_source"]');
            const genderRadios = document.querySelectorAll('input[name="gender"]');
            const genderDiv = document.getElementById('gender-selection');
            const iframe = document.getElementById('results-iframe');
            const messageArea = document.getElementById('message-area');
            const loadingOverlay = document.getElementById('loading-overlay');

            function findRaceData(raceName) {
                return racesData.find(race => race.name === raceName);
            }

            function showLoading() {
                loadingOverlay.style.display = 'block';
                iframe.style.display = 'none';
                messageArea.style.display = 'none';
            }

            function hideLoading() {
                loadingOverlay.style.display = 'none';
            }

            async function updateAll() {
                const selectedRaceName = raceSelect.value;
                const race = findRaceData(selectedRaceName);
                const source = document.querySelector('input[name="data_source"]:checked').value;
                const is703 = race.distance === '70.3';

                // Only get gender for 70.3 races
                const gender = is703 ? document.querySelector('input[name="gender"]:checked').value : null;

                if (is703) {
                    genderDiv.classList.remove('disabled-controls');
                    genderRadios.forEach(radio => radio.disabled = false);
                } else {
                    genderDiv.classList.add('disabled-controls');
                    genderRadios.forEach(radio => radio.disabled = true);
                }

                const urlFriendlyName = selectedRaceName.replace(/ /g, '_');
                let urlPath = `/results/${urlFriendlyName}/${source}`;
                if (is703) {
                    urlPath += `/${gender}`;
                }
                window.history.pushState({}, '', urlPath);

                // Show loading immediately
                showLoading();

                if (source === 'official_ag' && race.results_urls && race.results_urls.official_ag) {
                    let url = race.results_urls.official_ag;
                    if (is703) {
                        // Handle 70.3 race with gender-specific URLs
                        if (url[gender]) {
                            iframe.onload = hideLoading;
                            iframe.src = url[gender];
                            iframe.style.display = 'block';
                            messageArea.style.display = 'none';
                        } else {
                            iframe.style.display = 'none';
                            messageArea.style.display = 'block';
                            messageArea.innerText = 'Coming Soon!';
                        }
                    } else if (typeof url === 'string') {
                        // Handle 140.6 race with single URL
                        iframe.onload = hideLoading;
                        iframe.src = url;
                        iframe.style.display = 'block';
                        messageArea.style.display = 'none';
                    } else {
                        iframe.style.display = 'none';
                        messageArea.style.display = 'block';
                        messageArea.innerText = 'Coming Soon!';
                    }
                } else if (source === 'live') {
                    let liveUrl = `/live_results/${urlFriendlyName}/${gender}`;
                    iframe.onload = hideLoading;
                    iframe.src = liveUrl;
                    iframe.style.display = 'block';
                    messageArea.style.display = 'none';

                } else {
                    iframe.style.display = 'none';
                    messageArea.style.display = 'block';
                    messageArea.innerText = 'Coming Soon!';
                    hideLoading();
                }
            }

            let isInitialLoad = true;

            function onRaceChange() {
                const selectedRaceName = '{{ selected_race }}' || raceSelect.value;
                const race = findRaceData(selectedRaceName);
                const hasOfficialAg = race.results_urls && 'official_ag' in race.results_urls && race.results_urls.official_ag !== '';

                // Disable/enable official_ag radio based on URL availability
                const officialAgRadio = document.querySelector('input[name="data_source"][value="official_ag"]');
                officialAgRadio.disabled = !hasOfficialAg;
                officialAgRadio.parentElement.classList.toggle('disabled-controls', !hasOfficialAg);

                // Select appropriate radio button based on context
                let selectedSource;
                if (isInitialLoad) {
                    // On initial load, use the server-provided value
                    selectedSource = '{{ selected_source }}' || (hasOfficialAg ? 'official_ag' : 'live');
                    isInitialLoad = false;  // Reset flag after initial load
                } else {
                    // On subsequent changes, prefer official_ag if available
                    selectedSource = hasOfficialAg ? 'official_ag' : 'live';
                }
                document.querySelector(`input[name="data_source"][value="${selectedSource}"]`).checked = true;

                if (race.distance === '70.3') {
                    document.querySelector('input[name="gender"][value="men"]').checked = true;
                }

                updateAll();
            }

            raceSelect.addEventListener('change', onRaceChange);
            sourceRadios.forEach(radio => radio.addEventListener('change', updateAll));
            genderRadios.forEach(radio => radio.addEventListener('change', updateAll));

            onRaceChange();
        });
    </script>
</body>
</html>